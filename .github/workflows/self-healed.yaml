name: Verify MFA job execution via API

on:
  schedule:
    - cron: '10 * * * *'   # â° Runs every hour, 10 minutes after the main job
  workflow_dispatch:

jobs:
  verify_mfa_job:
    runs-on: ubuntu-latest

    steps:
    - name: ðŸ”„ Checkout repository
      uses: actions/checkout@v3

    - name: ðŸ“– Check last run via GitHub API
      id: check_run
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        WORKFLOW_FILE: mfa_alert.yml   # filename or numeric workflow ID of the main job
        MAX_AGE_MINUTES: '90'
      run: |
        echo "ðŸ” Checking last run of workflow $WORKFLOW_FILE ..."
        OWNER_REPO="${{ github.repository }}"
        OWNER=$(echo $OWNER_REPO | cut -d'/' -f1)
        REPO=$(echo $OWNER_REPO | cut -d'/' -f2)

        RESPONSE=$(curl -s -H "Authorization: Bearer $GITHUB_TOKEN" \
          -H "Accept: application/vnd.github+json" \
          "https://api.github.com/repos/$OWNER/$REPO/actions/workflows/$WORKFLOW_FILE/runs?per_page=5")

        LAST_RUN=$(echo "$RESPONSE" | jq -r '.workflow_runs[] | select(.status=="completed" and .conclusion=="success") | .run_started_at' | head -n1)

        if [ -z "$LAST_RUN" ]; then
          echo "âš ï¸ No successful runs found for workflow $WORKFLOW_FILE"
          echo "trigger_main=true" >> $GITHUB_OUTPUT
          exit 0
        fi

        echo "ðŸ•’ Last successful run started at: $LAST_RUN"
        LAST_RUN_EPOCH=$(date -u -d "$LAST_RUN" +%s)
        NOW_EPOCH=$(date -u +%s)
        AGE=$(( (NOW_EPOCH - LAST_RUN_EPOCH) / 60 ))

        echo "â±ï¸ Age of last run: $AGE minutes"

        if [ "$AGE" -gt "$MAX_AGE_MINUTES" ]; then
          echo "âš ï¸ Workflow $WORKFLOW_FILE has not run successfully in the last $MAX_AGE_MINUTES minutes."
          echo "trigger_main=true" >> $GITHUB_OUTPUT
        else
          echo "âœ… Workflow $WORKFLOW_FILE executed successfully within the last $MAX_AGE_MINUTES minutes."
          echo "trigger_main=false" >> $GITHUB_OUTPUT
        fi

    - name: ðŸš€ Trigger main workflow if needed
      if: steps.check_run.outputs.trigger_main == 'true'
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        WORKFLOW_FILE: mfa_alert.yml   # filename or numeric workflow ID of the main job
      run: |
        echo "ðŸš€ Triggering workflow $WORKFLOW_FILE ..."
        OWNER_REPO="${{ github.repository }}"
        OWNER=$(echo $OWNER_REPO | cut -d'/' -f1)
        REPO=$(echo $OWNER_REPO | cut -d'/' -f2)

        curl -X POST \
          -H "Authorization: Bearer $GITHUB_TOKEN" \
          -H "Accept: application/vnd.github+json" \
          https://api.github.com/repos/$OWNER/$REPO/actions/workflows/$WORKFLOW_FILE/dispatches \
          -d '{"ref":"main"}'
