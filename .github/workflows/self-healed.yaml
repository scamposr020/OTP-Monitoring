name: Self-Healing Scheduler

on:
  schedule:
    - cron: '10 * * * *'   # â° Runs every hour, 10 minutes after the main job
  workflow_dispatch:

jobs:
  verify_mfa_job:
    runs-on: ubuntu-latest

    steps:
    - name: ğŸ”„ Checkout repository
      uses: actions/checkout@v3

    - name: ğŸ“¥ Download last-run artifact
      uses: actions/download-artifact@v4
      with:
        name: last-run
        path: ./artifacts

    - name: ğŸ“– Read timestamp and verify
      run: |
        echo "ğŸ” Checking last execution timestamp..."
        LAST_RUN=$(cat ./artifacts/last_run.txt)
        NOW=$(date -u +%s)
        AGE=$((NOW - LAST_RUN))
        MAX_AGE=$((90 * 60))  # 90 minutes in seconds

        echo "ğŸ•’ Last run was $AGE seconds ago"

        if [ "$AGE" -gt "$MAX_AGE" ]; then
          echo "âš ï¸ MFA job has not run in the last 90 minutes. Please investigate."
          exit 1
        else
          echo "âœ… MFA job executed recently: $(date -u -d @$LAST_RUN)"
        fi
