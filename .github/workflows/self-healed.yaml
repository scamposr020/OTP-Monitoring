name: Verify MFA job execution via API

on:
  schedule:
    - cron: '10 * * * *'   # ‚è∞ Runs every hour, 10 minutes after the main job
  workflow_dispatch:

jobs:
  verify_mfa_job:
    runs-on: ubuntu-latest

    steps:
    - name: üîÑ Checkout repository
      uses: actions/checkout@v3

    - name: üìñ Check last run via GitHub API
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        WORKFLOW_FILE: mfa_alert.yml   # name of the workflow file of the main job
        MAX_AGE_MINUTES: '90'
      run: |
        echo "üîç Checking last run of workflow $WORKFLOW_FILE ..."
        OWNER_REPO="${{ github.repository }}"
        OWNER=$(echo $OWNER_REPO | cut -d'/' -f1)
        REPO=$(echo $OWNER_REPO | cut -d'/' -f2)

        # Query workflow runs
        RESPONSE=$(curl -s -H "Authorization: Bearer $GITHUB_TOKEN" \
          -H "Accept: application/vnd.github+json" \
          "https://api.github.com/repos/$OWNER/$REPO/actions/workflows/$WORKFLOW_FILE/runs?per_page=5")

        # Extract latest successful run start time
        LAST_RUN=$(echo "$RESPONSE" | jq -r '.workflow_runs[] | select(.status=="completed" and .conclusion=="success") | .run_started_at' | head -n1)

        if [ -z "$LAST_RUN" ]; then
          echo "‚ö†Ô∏è No successful runs found for workflow $WORKFLOW_FILE"
          exit 1
        fi

        echo "üïí Last successful run started at: $LAST_RUN"

        # Convert to epoch
        LAST_RUN_EPOCH=$(date -u -d "$LAST_RUN" +%s)
        NOW_EPOCH=$(date -u +%s)
        AGE=$(( (NOW_EPOCH - LAST_RUN_EPOCH) / 60 ))

        echo "‚è±Ô∏è Age of last run: $AGE minutes"

        if [ "$AGE" -gt "$MAX_AGE_MINUTES" ]; then
          echo "‚ö†Ô∏è Workflow $WORKFLOW_FILE has not run successfully in the last $MAX_AGE_MINUTES minutes."
          exit 1
        else
          echo "‚úÖ Workflow $WORKFLOW_FILE executed successfully within the last $MAX_AGE_MINUTES minutes."
        fi
